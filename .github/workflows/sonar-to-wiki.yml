name: Release Quality Report

on:
  push:
    tags:
      - "v[0-9]*.0.0"
  workflow_dispatch:
    inputs:
      version:
        description: "Version label (e.g., v2.0.0)"
        required: true
        default: "v1.0.0"

env:
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

permissions:
  contents: write

jobs:
  release_report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. CLONE WIKI FIRST
      - name: Clone Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.wiki.git" wiki_repo

      # 2. RUN SONAR SCAN
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      # 3. GENERATE ENHANCED REPORT
      - name: Generate Detailed SonarCloud Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          set -e
          mkdir -p out
          REPORT="out/Code-Quality-${VERSION}.md"

          echo "Waiting for SonarCloud API..."
          sleep 45 

          # Fetch Overall Data
          curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=alert_status,bugs,reliability_rating,code_smells,sqale_rating,security_hotspots,security_review_rating,coverage,duplicated_lines_density,ncloc,vulnerabilities,security_rating" > out/metrics.json
          curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/hotspots/search?projectKey=${SONAR_PROJECT_KEY}&status=TO_REVIEW" > out/hotspot_list.json
          curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&resolved=false&ps=100" > out/issues.json

          # Helper functions
          metric () { jq -r --arg k "$1" '.component.measures[]? | select(.metric==$k) | .value' out/metrics.json | head -n 1; }
          get_rating () {
            val=$(metric "$1"); case "${val%.*}" in 1) echo "A" ;; 2) echo "B" ;; 3) echo "C" ;; 4) echo "D" ;; 5) echo "E" ;; *) echo "N/A" ;; esac
          }

          # Get current values
          BUGS=$(metric bugs || echo 0)
          SMELLS=$(metric code_smells || echo 0)
          COV=$(metric coverage || echo 0)
          HOTSPOTS=$(metric security_hotspots || echo 0)

          # --- EVOLUTION LOGIC ---
          MAJOR=$(echo $VERSION | cut -d. -f1 | tr -d 'v')
          PREV_MAJOR=$((MAJOR - 1))
          PREV_VERSION="v${PREV_MAJOR}.0.0"
          PREV_FILE="wiki_repo/Code-Quality-${PREV_VERSION}.md"

          HAS_PREV=false
          if [ -f "$PREV_FILE" ]; then
            HAS_PREV=true
            OLD_BUGS=$(grep "| Total Bugs |" "$PREV_FILE" | awk -F'|' '{print $3}' | tr -d ' ' || echo 0)
            OLD_SMELLS=$(grep "| Code Smells |" "$PREV_FILE" | awk -F'|' '{print $3}' | tr -d ' ' || echo 0)
            OLD_COV=$(grep "| Overall Line Coverage |" "$PREV_FILE" | awk -F'|' '{print $3}' | tr -d ' %' || echo 0)
            OLD_HOTSPOTS=$(grep "| Hotspots to Review |" "$PREV_FILE" | awk -F'|' '{print $3}' | tr -d ' ' || echo 0)
          fi

          {
            echo "# Deep Quality Report: ${VERSION}"
            echo "---"

            echo -e "\n## Reliability"
            echo "| Metric | Value | Rating |"
            echo "|---|---|---|"
            echo "| Total Bugs | $BUGS | $(get_rating reliability_rating) |"
            if [ "$BUGS" -gt 0 ]; then
              echo -e "\n### Bug Details"
              echo "| Severity | Message | File |"
              echo "|---|---|---|"
              jq -r '.issues[] | select(.type=="BUG") | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi

            echo -e "\n## Maintainability"
            echo "| Metric | Value | Rating |"
            echo "|---|---|---|"
            echo "| Code Smells | $SMELLS | $(get_rating sqale_rating) |"
            if [ "$SMELLS" -gt 0 ]; then
              echo -e "\n### Code Smell Details"
              echo "| Severity | Message | File |"
              echo "|---|---|---|"
              jq -r '.issues[] | select(.type=="CODE_SMELL") | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi

            echo -e "\n## Security Review"
            echo "| Metric | Value | Rating |"
            echo "|---|---|---|"
            echo "| Hotspots to Review | $HOTSPOTS | $(get_rating security_review_rating) |"
            if [ "$HOTSPOTS" -gt 0 ]; then
              echo -e "\n### Security Review: Hotspot Details"
              echo "| Probability | Message | File:Line |"
              echo "|---|---|---|"
              for key in $(jq -r '.hotspots[].key' out/hotspot_list.json); do
                curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/hotspots/show?hotspot=$key" > out/temp_hotspot.json
                PROB=$(jq -r '.rule.vulnerabilityProbability' out/temp_hotspot.json)
                MSG=$(jq -r '.message' out/temp_hotspot.json)
                FILE=$(jq -r '.component.path' out/temp_hotspot.json)
                LINE=$(jq -r '.line' out/temp_hotspot.json)
                echo "| $PROB | $MSG | \`$FILE:$LINE\` |" >> "$REPORT"
              done
            fi

            echo -e "\n## Coverage & Duplication"
            echo "| Metric | Value |"
            echo "|---|---|"
            echo "| Overall Line Coverage | ${COV}% |"
            echo "| Duplicated Lines (%) | $(metric duplicated_lines_density || echo 0)% |"

            echo -e "\n## Size & Issues"
            echo "| Metric | Value | Rating |"
            echo "|---|---|---|"
            echo "| Lines of Code (NCLOC) | $(metric ncloc || echo 0) | - |"
            VULNS=$(metric vulnerabilities || echo 0)
            echo "| Vulnerabilities | $VULNS | $(get_rating security_rating) |"
            if [ "$VULNS" -gt 0 ]; then
               echo -e "\n### Vulnerability Details"
               echo "| Severity | Message | File |"
               echo "|---|---|---|"
               jq -r '.issues[] | select(.type=="VULNERABILITY") | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi

            # --- METRICS EVOLUTION (WITH HOTSPOTS) ---
            if [ "$HAS_PREV" = true ]; then
              echo -e "\n## Metrics Evolution"
              echo "Comparing **${PREV_VERSION}** & **${VERSION}**"
              echo ""
              echo "| Metric | ${PREV_VERSION} | ${VERSION} | Trend |"
              echo "|---|---|---|---|"
              trend() { if [ "$(echo "$2 > $1" | bc -l)" -eq 1 ]; then echo "ðŸ”º"; elif [ "$(echo "$2 < $1" | bc -l)" -eq 1 ]; then echo "ðŸ”»"; else echo "âž–"; fi; }
              echo "| Bugs | $OLD_BUGS | $BUGS | $(trend $OLD_BUGS $BUGS) |"
              echo "| Code Smells | $OLD_SMELLS | $SMELLS | $(trend $OLD_SMELLS $SMELLS) |"
              echo "| Hotspots | $OLD_HOTSPOTS | $HOTSPOTS | $(trend $OLD_HOTSPOTS $HOTSPOTS) |"
              echo "| Coverage | ${OLD_COV}% | ${COV}% | $(trend $OLD_COV $COV) |"
              echo ""
              echo "### Visual Trend"
              echo "\`\`\`mermaid"
              echo "graph LR"
              echo "  B1(Bugs: $OLD_BUGS) --> B2(Bugs: $BUGS)"
              echo "  S1(Smells: $OLD_SMELLS) --> S2(Smells: $SMELLS)"
              echo "  H1(Hotspots: $OLD_HOTSPOTS) --> H2(Hotspots: $HOTSPOTS)"
              echo "\`\`\`"
            fi
            
          } >> "$REPORT"

      # 4. PUBLISH TO WIKI
      - name: Publish to Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd wiki_repo
          cp ../out/Code-Quality-${VERSION}.md .
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          git add .
          git commit -m "Add SonarCloud report for ${VERSION}" || echo "No changes"
          git push
