name: Release Quality Report

on:
  push:
    tags:
      - "v[0-9]*.0.0"
  workflow_dispatch:
    inputs:
      version:
        description: "Version/tag label to use"
        required: true
        default: "v0.0.0-test"

env:
  # Uses the input version if manually triggered, otherwise uses the tag name
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

permissions:
  contents: write

jobs:
  release_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      - name: Generate Detailed SonarCloud Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          set -e
          mkdir -p out
          REPORT="out/Code-Quality-${VERSION}.md"

          # Fetch key measures from SonarCloud API
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=alert_status,ncloc,duplicated_lines_density,comment_lines_density,cognitive_complexity,sqale_index,bugs,vulnerabilities,code_smells,security_hotspots" \
            > out/metrics.json

          # Helper functions to extract data
          metric () {
            jq -r --arg k "$1" '.component.measures[]? | select(.metric==$k) | .value' out/metrics.json | head -n 1
          }
          val_or_na () {
            v="$(metric "$1")"
            if [ -z "$v" ] || [ "$v" = "null" ]; then echo "0"; else echo "$v"; fi
          }

          # Assign variables
          QUALITY_GATE="$(metric alert_status)"
          LOC="$(val_or_na ncloc)"
          DUP="$(val_or_na duplicated_lines_density)"
          DOC="$(val_or_na comment_lines_density)"
          CCO="$(val_or_na cognitive_complexity)"
          DEBT_MIN="$(val_or_na sqale_index)"
          BUGS="$(val_or_na bugs)"
          VULNS="$(val_or_na vulnerabilities)"
          SMELLS="$(val_or_na code_smells)"
          HOTSPOTS="$(val_or_na security_hotspots)"

          # Convert Technical Debt minutes to hours/mins
          DEBT_INT=$(printf "%.0f" "$DEBT_MIN")
          HOURS=$((DEBT_INT / 60))
          MINS=$((DEBT_INT % 60))
          TECH_DEBT="${HOURS}h ${MINS}m"

          # Construct the Markdown Report
          {
            echo "# üöÄ Code Quality Report ‚Äì ${VERSION}"
            echo ""
            echo "### Status Badges"
            echo "[![Quality Gate](https://sonarcloud.io/api/project_badges/measure?project=${SONAR_PROJECT_KEY}&metric=alert_status)](https://sonarcloud.io/dashboard?id=${SONAR_PROJECT_KEY})"
            echo "[![Bugs](https://sonarcloud.io/api/project_badges/measure?project=${SONAR_PROJECT_KEY}&metric=bugs)](https://sonarcloud.io/project/issues?id=${SONAR_PROJECT_KEY}&resolved=false&types=BUG)"
            echo ""
            echo "---"
            echo "## üìä Executive Summary"
            echo "- **Release Tag:** \`${VERSION}\`"
            echo "- **Commit SHA:** \`${GITHUB_SHA}\`"
            echo "- **Quality Gate:** **${QUALITY_GATE}**"
            echo "- **Full Analysis:** [View Dashboard on SonarCloud](https://sonarcloud.io/dashboard?id=${SONAR_PROJECT_KEY})"
            echo ""
            echo "## üìê Technical Metrics"
            echo "| Category | Metric | Value | Status |"
            echo "|---|---|---|---|"
            echo "| üìÅ Size | Lines of Code | ${LOC} | -" |
            echo "| üëØ Duplication | Duplicated Lines | ${DUP}% | $([ $(echo "$DUP < 5" | bc) -eq 1 ] && echo "‚úÖ" || echo "‚ö†Ô∏è") |"
            echo "| üìù Docs | Comment Density | ${DOC}% | -" |
            echo "| üß† Logic | Cognitive Complexity | ${CCO} | -" |
            echo ""
            echo "## üõ°Ô∏è Security & Reliability"
            echo "| Metric | Count | Action |"
            echo "|---|---|---|"
            echo "| üêû Bugs | ${BUGS} | $([ "$BUGS" -eq 0 ] && echo "‚úÖ Clean" || echo "‚ùå Requires Fix") |"
            echo "| üõ°Ô∏è Vulnerabilities | ${VULNS} | $([ "$VULNS" -eq 0 ] && echo "‚úÖ Secure" || echo "‚ùå Critical") |"
            echo "| ‚ö° Security Hotspots | ${HOTSPOTS} | $([ "$HOTSPOTS" -eq 0 ] && echo "‚úÖ Clean" || echo "üîç Review") |"
            echo "| üí∏ Tech Debt | ${TECH_DEBT} | ${SMELLS} Smells |"
            echo ""
            echo "---"
            echo "_Report generated automatically via GitHub Actions._"
          } > "$REPORT"

      - name: Publish to Wiki
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          
          # Clone the wiki repository
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.wiki.git" wiki_repo
          
          # Copy the generated report to the wiki folder
          cp out/Code-Quality-${VERSION}.md wiki_repo/
          
          cd wiki_repo
          git add .
          git commit -m "Update quality report for ${VERSION}" || echo "No changes"
          git push
