name: Release Quality Report

on:
  push:
    tags:
      - "v[0-9]*.0.0"
  workflow_dispatch:
    inputs:
      version:
        description: "Version/tag label to use"
        required: true
        default: "v0.0.0-test"

env:
  # Uses the input version if manually triggered, otherwise uses the tag name
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

permissions:
  contents: write

jobs:
  release_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      - name: Generate Detailed SonarCloud Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          set -e
          mkdir -p out
          REPORT="out/Code-Quality-${VERSION}.md"

          echo "Waiting for SonarCloud processing..."
          sleep 40 

          # 1. Fetch Overall Measures (using 'component' API for total counts)
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=alert_status,bugs,vulnerabilities,code_smells,security_hotspots,security_review_rating,security_rating,reliability_rating,sqale_rating,coverage,ncloc" \
            > out/metrics.json

          # 2. Fetch Quality Gate Details
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}" \
            > out/gate_status.json

          # 3. Fetch Hotspot Details (Specific API for Hotspots)
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/hotspots/search?projectKey=${SONAR_PROJECT_KEY}&status=TO_REVIEW&ps=5" \
            > out/hotspots.json

          # 4. Fetch Detailed Issues (Bugs & Smells)
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&resolved=false&types=BUG,CODE_SMELL&ps=10&s=SEVERITY&asc=false" \
            > out/issues.json

          # Helper functions
          metric () { jq -r --arg k "$1" '.component.measures[]? | select(.metric==$k) | .value' out/metrics.json | head -n 1; }
          
          get_rating () {
            val=$(metric "$1")
            case "${val%.*}" in
              1) echo "A" ;; 2) echo "B" ;; 3) echo "C" ;; 4) echo "D" ;; 5) echo "E" ;; *) echo "N/A" ;;
            esac
          }

          QUALITY_GATE=$(jq -r '.projectStatus.status' out/gate_status.json)

          {
            echo "# ðŸš€ Overall Code Quality Report â€“ ${VERSION}"
            echo "### Quality Gate Status: $([[ "$QUALITY_GATE" == "OK" ]] && echo "âœ… PASSED" || echo "âŒ FAILED")"
            echo ""

            if [ "$QUALITY_GATE" != "OK" ]; then
              echo "#### âš ï¸ Why it failed:"
              jq -r '.projectStatus.conditions[] | select(.status=="ERROR") | "- **\(.metricKey)**: Actual \(.actualValue) (Goal: \(.comparator) \(.errorThreshold))"' out/gate_status.json >> "$REPORT"
              echo ""
            fi

            echo "## ðŸ›¡ï¸ Security & Hotspots"
            echo "| Metric | Total Count | Rating |"
            echo "|---|---|---|"
            echo "| Security Hotspots | $(metric security_hotspots || echo 0) | $(get_rating security_review_rating) |"
            echo "| Vulnerabilities | $(metric vulnerabilities || echo 0) | $(get_rating security_rating) |"
            echo ""
            
            # Hotspot Details Block
            if [ "$(jq '.hotspots | length' out/hotspots.json)" -gt 0 ]; then
              echo "#### ðŸ” Security Hotspot Details"
              echo "| Severity | Security Category | File |"
              echo "|---|---|---|"
              jq -r '.hotspots[] | "| \(.vulnerabilityProbability) | \(.securityCategory) | \(.component | split(":") | .[-1]) |"' out/hotspots.json >> "$REPORT"
              echo ""
            fi

            echo "## ðŸ› ï¸ Reliability & Maintainability"
            echo "| Metric | Total Count | Rating |"
            echo "|---|---|---|"
            echo "| Bugs | $(metric bugs || echo 0) | $(get_rating reliability_rating) |"
            echo "| Code Smells | $(metric code_smells || echo 0) | $(get_rating sqale_rating) |"
            echo ""

            # Issue Details Block (Bugs and Smells)
            if [ "$(jq '.issues | length' out/issues.json)" -gt 0 ]; then
              echo "#### ðŸž Bug & Code Smell Details"
              echo "| Type | Severity | Message | File |"
              echo "|---|---|---|---|"
              jq -r '.issues[] | "| \(.type) | \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
              echo ""
            fi

            echo "## ðŸ“ General Measures (Overall)"
            echo "| Metric | Value |"
            echo "|---|---:|"
            echo "| Lines of Code | $(metric ncloc) |"
            echo "| Test Coverage | $(metric coverage || echo 0)% |"
            echo ""
            echo "---"
            echo "_Generated on $(date -u) | [Full Dashboard](https://sonarcloud.io/dashboard?id=${SONAR_PROJECT_KEY})_"
          } > "$REPORT"
          
      - name: Publish to Wiki
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          
          # Clone the wiki repository
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.wiki.git" wiki_repo
          
          # Copy the generated report to the wiki folder
          cp out/Code-Quality-${VERSION}.md wiki_repo/
          
          cd wiki_repo
          git add .
          git commit -m "Update quality report for ${VERSION}" || echo "No changes"
          git push
