name: Release Quality Report

on:
  push:
    tags:
      - "v[0-9]*.0.0"
  workflow_dispatch:
    inputs:
      version:
        description: "Version label (e.g., v2.0.0)"
        required: true
        default: "v1.0.0"

env:
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

permissions:
  contents: write

jobs:
  release_report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. CLONE WIKI FIRST (To read previous version data)
      - name: Clone Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.wiki.git" wiki_repo

      # 2. RUN SONAR SCAN
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      # 3. GENERATE ENHANCED REPORT
      - name: Generate Detailed SonarCloud Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          set -e
          mkdir -p out
          REPORT="out/Code-Quality-${VERSION}.md"

          echo "Waiting for SonarCloud API..."
          sleep 45 

          # 1. Fetch Master Metrics
          curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=alert_status,bugs,reliability_rating,code_smells,sqale_rating,security_hotspots,security_review_rating,coverage,duplicated_lines_density,ncloc,vulnerabilities,security_rating" > out/metrics.json
          
          # 2. Fetch General Issues
          curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&resolved=false&ps=100" > out/issues.json

          # 3. Fetch Hotspot List (to get the keys)
          curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/hotspots/search?projectKey=${SONAR_PROJECT_KEY}&status=TO_REVIEW" > out/hotspot_list.json

          # Helper functions
          metric () { jq -r --arg k "$1" '.component.measures[]? | select(.metric==$k) | .value' out/metrics.json | head -n 1; }
          get_rating () {
            val=$(metric "$1"); case "${val%.*}" in 1) echo "A" ;; 2) echo "B" ;; 3) echo "C" ;; 4) echo "D" ;; 5) echo "E" ;; *) echo "-" ;; esac
          }

          BUGS=$(metric bugs || echo 0)
          SMELLS=$(metric code_smells || echo 0)
          HOTSPOTS=$(metric security_hotspots || echo 0)
          VULNS=$(metric vulnerabilities || echo 0)
          COV=$(metric coverage || echo 0)
          DUP=$(metric duplicated_lines_density || echo 0)
          LOC=$(metric ncloc || echo 0)

          {
            echo "# Quality Report: ${VERSION}"
            echo "---"

            # Master Summary Table
            echo "## Master Metrics Summary"
            echo "| Measure | Metric | Rating | Value |"
            echo "|---|---|:---:|---|"
            echo "| **Reliability** | Total Bugs | $(get_rating reliability_rating) | $BUGS |"
            echo "| **Maintainability** | Code Smells | $(get_rating sqale_rating) | $SMELLS |"
            echo "| **Security Review** | Hotspots | $(get_rating security_review_rating) | $HOTSPOTS |"
            echo "| **Security** | Vulnerabilities | $(get_rating security_rating) | $VULNS |"
            echo "| **Coverage** | Unit Test Coverage | - | ${COV}% |"
            echo "| **Duplication** | Duplicated Lines | - | ${DUP}% |"
            echo "| **Size** | Lines of Code | - | $LOC |"
            echo ""

            echo "## Detailed Findings"
            
            # --- IMPROVED HOTSPOT DETAILS ---
            if [ "$HOTSPOTS" -gt 0 ]; then
              echo "### Security Review: Hotspot Details"
              echo "| Probability | Message | File:Line |"
              echo "|---|---|---|"
              
              # Loop through each hotspot key found in the search
              for key in $(jq -r '.hotspots[].key' out/hotspot_list.json); do
                # Fetch the specific details for this hotspot
                curl -s -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/hotspots/show?hotspot=$key" > out/temp_hotspot.json
                
                # Extract details based on the schema you provided
                PROB=$(jq -r '.rule.vulnerabilityProbability' out/temp_hotspot.json)
                MSG=$(jq -r '.message' out/temp_hotspot.json)
                FILE=$(jq -r '.component.path' out/temp_hotspot.json)
                LINE=$(jq -r '.line' out/temp_hotspot.json)
                
                echo "| $PROB | $MSG | \`$FILE:$LINE\` |" >> "$REPORT"
              done
              echo ""
            fi

            # --- OTHER DETAILS (Bugs, Smells, etc.) ---
            if [ "$BUGS" -gt 0 ]; then
              echo "### Reliability: Bug Details"
              echo "| Severity | Message | File |"
              echo "|---|---|---|"
              jq -r '.issues[] | select(.type=="BUG") | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi

            if [ "$SMELLS" -gt 0 ]; then
              echo -e "\n### Maintainability: Code Smell Details"
              echo "| Severity | Message | File |"
              echo "|---|---|---|"
              jq -r '.issues[] | select(.type=="CODE_SMELL") | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi

            echo -e "\n---"
            echo "_[Full Dashboard](https://sonarcloud.io/dashboard?id=${SONAR_PROJECT_KEY})_"
          } >> "$REPORT"

      # 4. PUBLISH TO WIKI
      - name: Publish to Wiki
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd wiki_repo
          cp ../out/Code-Quality-${VERSION}.md .
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          git add .
          git commit -m "Add SonarCloud report for ${VERSION}" || echo "No changes"
          git push
