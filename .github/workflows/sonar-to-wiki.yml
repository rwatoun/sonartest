name: Release Quality Report

on:
  push:
    tags:
      - "v[0-9]*.0.0"
  workflow_dispatch:
    inputs:
      version:
        description: "Version/tag label to use"
        required: true
        default: "v0.0.0-test"

env:
  # Uses the input version if manually triggered, otherwise uses the tag name
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

permissions:
  contents: write

jobs:
  release_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      - name: Generate Detailed SonarCloud Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          set -e
          mkdir -p out
          REPORT="out/Code-Quality-${VERSION}.md"

          echo "Waiting for SonarCloud background processing..."
          sleep 45 

          # 1. Fetch Overall Measures
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=alert_status,bugs,reliability_rating,vulnerabilities,security_rating,code_smells,sqale_rating,security_hotspots,security_review_rating,coverage,duplicated_lines_density,ncloc" \
            > out/metrics.json

          # 2. Fetch Security Hotspots (MUST use projectKey)
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/hotspots/search?projectKey=${SONAR_PROJECT_KEY}" \
            > out/hotspots.json

          # 3. Fetch All Issues (Bugs, Smells)
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&resolved=false&ps=100" \
            > out/issues.json

          # Helper Functions
          metric () { jq -r --arg k "$1" '.component.measures[]? | select(.metric==$k) | .value' out/metrics.json | head -n 1; }
          get_rating () {
            val=$(metric "$1"); case "${val%.*}" in 1) echo "A" ;; 2) echo "B" ;; 3) echo "C" ;; 4) echo "D" ;; 5) echo "E" ;; *) echo "N/A" ;; esac
          }

          {
            echo "# ðŸ“Š Quality Report: ${VERSION} (Overall Code)"
            echo "---"

            # --- RELIABILITY ---
            BUGS=$(metric bugs || echo 0)
            echo "## ðŸ”´ Reliability"
            echo "| Metric | Value | Rating |"
            echo "|---|---|---|"
            echo "| Bugs | $BUGS | $(get_rating reliability_rating) |"
            if [ "$BUGS" -gt 0 ]; then
              echo -e "\n### ðŸž Bug Details"
              echo "| Severity | Message | File |"
              jq -r '.issues[] | select(.type=="BUG") | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi

            # --- MAINTAINABILITY ---
            SMELLS=$(metric code_smells || echo 0)
            echo -e "\n## ðŸŸ¡ Maintainability"
            echo "| Metric | Value | Rating |"
            echo "|---|---|---|"
            echo "| Code Smells | $SMELLS | $(get_rating sqale_rating) |"
            if [ "$SMELLS" -gt 0 ]; then
              echo -e "\n### ðŸ§¹ Code Smell Details"
              echo "| Severity | Message | File |"
              jq -r '.issues[] | select(.type=="CODE_SMELL") | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi

            # --- SECURITY REVIEW ---
            # NOTE: Hotspots use different field names (message might be null, so we use ruleKey as fallback)
            HOTSPOTS=$(metric security_hotspots || echo 0)
            echo -e "\n## ðŸŸ  Security Review"
            echo "| Metric | Value | Rating |"
            echo "|---|---|---|"
            echo "| Hotspots to Review | $HOTSPOTS | $(get_rating security_review_rating) |"
            
            if [ "$HOTSPOTS" -gt 0 ]; then
              echo -e "\n### ðŸ” Security Hotspot Details"
              echo "| Category | Message/Rule | File |"
              echo "|---|---|---|"
              # We use 'message // ruleKey' to ensure the table isn't empty if the message field is null
              jq -r '.hotspots[] | "| \(.securityCategory) | \(.message // .ruleKey) | \(.component | split(":") | .[-1]) |"' out/hotspots.json >> "$REPORT"
            fi

            # --- COVERAGE ---
            echo -e "\n## ðŸŸ¢ Coverage"
            echo "| Metric | Value |"
            echo "|---|---|"
            echo "| Unit Test Coverage | $(metric coverage || echo 0)% |"

            # --- DUPLICATION ---
            echo -e "\n## ðŸ‘¥ Duplication"
            echo "| Metric | Value |"
            echo "|---|---|"
            echo "| Duplicated Lines (%) | $(metric duplicated_lines_density || echo 0)% |"

            # --- SIZE ---
            echo -e "\n## ðŸ“ Size"
            echo "| Metric | Value |"
            echo "|---|---|"
            echo "| Lines of Code (ncloc) | $(metric ncloc || echo 0) |"

            # --- ISSUES (VULNERABILITIES) ---
            VULNS=$(metric vulnerabilities || echo 0)
            echo -e "\n## ðŸš¨ Issues"
            echo "| Type | Total Count | Rating |"
            echo "|---|---|---|"
            echo "| Vulnerabilities | $VULNS | $(get_rating security_rating) |"
            if [ "$VULNS" -gt 0 ]; then
              echo -e "\n### ðŸ›¡ï¸ Vulnerability Details"
              echo "| Severity | Message | File |"
              jq -r '.issues[] | select(.type=="VULNERABILITY") | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi

            echo -e "\n---"
            echo "_[Full Dashboard](https://sonarcloud.io/dashboard?id=${SONAR_PROJECT_KEY})_"
          } > "$REPORT"
          
      - name: Publish to Wiki
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          
          # Clone the wiki repository
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.wiki.git" wiki_repo
          
          # Copy the generated report to the wiki folder
          cp out/Code-Quality-${VERSION}.md wiki_repo/
          
          cd wiki_repo
          git add .
          git commit -m "Update quality report for ${VERSION}" || echo "No changes"
          git push
