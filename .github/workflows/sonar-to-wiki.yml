name: Release Quality Report

on:
  push:
    tags:
      - "v[0-9]*.0.0"
  workflow_dispatch:
    inputs:
      version:
        description: "Version/tag label to use"
        required: true
        default: "v0.0.0-test"

env:
  # Uses the input version if manually triggered, otherwise uses the tag name
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

permissions:
  contents: write

jobs:
  release_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/__pycache__/**

      - name: Generate Detailed SonarCloud Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          set -e
          mkdir -p out
          REPORT="out/Code-Quality-${VERSION}.md"

          echo "Waiting for SonarCloud background processing..."
          sleep 40 # Increased wait for issues and ratings to populate

          # 1. Fetch Measures
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=alert_status,ncloc,duplicated_lines_density,cognitive_complexity,sqale_index,bugs,vulnerabilities,code_smells,security_hotspots,coverage,security_rating,reliability_rating" \
            > out/metrics.json

          # 2. Fetch Quality Gate Details (To see WHY it failed)
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}" \
            > out/gate_status.json

          # 3. Fetch Top 5 Issues
          curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&resolved=false&ps=5&s=SEVERITY&asc=false" \
            > out/issues.json

          # Helper functions
          metric () { jq -r --arg k "$1" '.component.measures[]? | select(.metric==$k) | .value' out/metrics.json | head -n 1; }
          
          # Improved Rating Converter (Handles 1, 1.0, or empty)
          get_rating () {
            val=$(metric "$1")
            case "${val%.*}" in
              1) echo "A" ;;
              2) echo "B" ;;
              3) echo "C" ;;
              4) echo "D" ;;
              5) echo "E" ;;
              *) echo "N/A" ;;
            esac
          }

          QUALITY_GATE=$(jq -r '.projectStatus.status' out/gate_status.json)

          {
            echo "# ðŸš€ Code Quality Report â€“ ${VERSION}"
            echo "### Quality Gate: $([[ "$QUALITY_GATE" == "OK" ]] && echo "âœ… PASSED" || echo "âŒ FAILED")"
            echo ""

            # --- WHY DID IT FAIL? ---
            if [ "$QUALITY_GATE" != "OK" ]; then
              echo "#### âš ï¸ Failure Reasons:"
              jq -r '.projectStatus.conditions[] | select(.status=="ERROR") | "- **\(.metricKey)**: Actual value \(.actualValue) (Threshold: \(.comparator) \(.errorThreshold))"' out/gate_status.json >> "$REPORT"
              echo ""
            fi

            echo "## ðŸ“ˆ Key Performance Indicators"
            echo "| Metric | Value | Rating |"
            echo "|---|---|---|"
            echo "| **Reliability** | $(metric bugs || echo 0) Bugs | $(get_rating reliability_rating) |"
            echo "| **Security** | $(metric vulnerabilities || echo 0) Vulns | $(get_rating security_rating) |"
            echo "| **Test Coverage** | $(metric coverage || echo 0)% | - |"
            echo "| **Technical Debt** | $(metric sqale_index || echo 0) min | - |"
            echo ""

            echo "## âš ï¸ Top 5 Unresolved Issues"
            echo "| Severity | Issue | File |"
            echo "|---|---|---|"
            # Check if issues exist
            if [ "$(jq '.issues | length' out/issues.json)" -eq 0 ]; then
              echo "| - | No issues detected (or still processing) | - |" >> "$REPORT"
            else
              jq -r '.issues[] | "| \(.severity) | \(.message) | \(.component | split(":") | .[-1]) |"' out/issues.json >> "$REPORT"
            fi
            
            echo ""
            echo "## ðŸ“ All Metrics"
            echo "| Metric | Value |"
            echo "|---|---:|"
            echo "| Lines of Code | $(metric ncloc || echo 0) |"
            echo "| Duplication | $(metric duplicated_lines_density || echo 0)% |"
            echo "| Cognitive Complexity | $(metric cognitive_complexity || echo 0) |"
            echo ""
            echo "---"
            echo "_Dashboard: [SonarCloud](https://sonarcloud.io/dashboard?id=${SONAR_PROJECT_KEY})_"
          } > "$REPORT"
          
      - name: Publish to Wiki
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          
          # Clone the wiki repository
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.wiki.git" wiki_repo
          
          # Copy the generated report to the wiki folder
          cp out/Code-Quality-${VERSION}.md wiki_repo/
          
          cd wiki_repo
          git add .
          git commit -m "Update quality report for ${VERSION}" || echo "No changes"
          git push
